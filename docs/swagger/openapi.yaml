openapi: 3.0.3
info:
  title: SuperCore API
  version: 1.0.0
  description: |
    # SuperCore - Universal Entity Management Platform API

    SuperCore is a revolutionary meta-platform for creating Core Banking systems through natural language.

    ## Core Concepts

    - **Oracle**: Platform consciousness that knows its identity, licenses, and capabilities
    - **Object Definitions**: Blueprints (DNA) for all entities in the system
    - **Instances**: Living entities created from object definitions
    - **Relationships**: Connections between instances forming a semantic graph
    - **Validation Rules**: Reusable business rules and compliance checks

    ## Authentication

    Currently in development. Future versions will use Logto for OAuth 2.0/OIDC.

    ## Rate Limiting

    Default: 100 requests per minute per IP

    ## Versioning

    API version is included in the URL path: `/api/v1/`

  contact:
    name: SuperCore Team
    email: dev@lbpay.com
  license:
    name: Proprietary

servers:
  - url: http://localhost:8080/api/v1
    description: Local development server
  - url: https://api-dev.supercore.lbpay.com/api/v1
    description: Development environment
  - url: https://api.supercore.lbpay.com/api/v1
    description: Production environment

tags:
  - name: Oracle
    description: Platform consciousness and identity management
  - name: Object Definitions
    description: Blueprint management for all entities
  - name: Instances
    description: Living entities created from object definitions
  - name: Relationships
    description: Connections between instances
  - name: Validation Rules
    description: Reusable business rules and compliance checks
  - name: NL Assistant
    description: Natural Language processing for object creation
  - name: Health
    description: System health and readiness checks

paths:
  /health:
    get:
      tags: [Health]
      summary: Health check endpoint
      description: Returns the current health status of the API
      operationId: healthCheck
      responses:
        '200':
          description: Service is healthy
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: healthy
                  timestamp:
                    type: integer
                    format: int64
                    example: 1702156800
                  service:
                    type: string
                    example: supercore-api

  # ============================================================================
  # ORACLE ENDPOINTS - Platform Consciousness
  # ============================================================================

  /oracle/whoami:
    get:
      tags: [Oracle]
      summary: Ask the platform "Who am I?"
      description: |
        Returns a natural language description of the platform's identity,
        combining corporate information, licenses, and capabilities.

        This is the Oracle's self-awareness - it knows who it is.
      operationId: oracleWhoAmI
      responses:
        '200':
          description: Platform identity description
          content:
            application/json:
              schema:
                type: object
                properties:
                  response:
                    type: string
                    example: "Eu sou LBPAY (CNPJ: 12.345.678/0001-90), uma instituição financeira autorizada pelo Banco Central..."

  /oracle/identity:
    get:
      tags: [Oracle]
      summary: Get corporate identity
      description: Returns the platform's corporate identity (CNPJ, name, etc.)
      operationId: getOracleIdentity
      responses:
        '200':
          description: Corporate identity
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OracleIdentity'

  /oracle/licenses:
    get:
      tags: [Oracle]
      summary: Get active BACEN licenses
      description: Returns all active regulatory licenses and authorizations
      operationId: getOracleLicenses
      responses:
        '200':
          description: List of active licenses
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/License'

  /oracle/status:
    get:
      tags: [Oracle]
      summary: Get complete platform status
      description: |
        Returns comprehensive platform status including:
        - Corporate identity
        - Active licenses
        - System integrations
        - Operational status
      operationId: getOracleStatus
      responses:
        '200':
          description: Complete platform status
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OracleStatus'

  # ============================================================================
  # OBJECT DEFINITIONS ENDPOINTS
  # ============================================================================

  /object-definitions:
    get:
      tags: [Object Definitions]
      summary: List all object definitions
      description: Returns a paginated list of object definitions
      operationId: listObjectDefinitions
      parameters:
        - name: category
          in: query
          schema:
            type: string
            enum: [BUSINESS_ENTITY, RULE, POLICY, INTEGRATION, LOGIC]
          description: Filter by category
        - name: is_active
          in: query
          schema:
            type: boolean
          description: Filter by active status
        - name: limit
          in: query
          schema:
            type: integer
            default: 20
            minimum: 1
            maximum: 100
        - name: offset
          in: query
          schema:
            type: integer
            default: 0
            minimum: 0
      responses:
        '200':
          description: List of object definitions
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/ObjectDefinition'
                  total:
                    type: integer
                  limit:
                    type: integer
                  offset:
                    type: integer

    post:
      tags: [Object Definitions]
      summary: Create a new object definition
      description: Creates a new object definition (blueprint)
      operationId: createObjectDefinition
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateObjectDefinition'
            examples:
              conta_corrente:
                summary: Conta Corrente (Checking Account)
                value:
                  name: conta_corrente
                  display_name: Conta Corrente PF
                  description: Conta corrente para pessoa física
                  category: BUSINESS_ENTITY
                  schema:
                    type: object
                    required: [cpf, nome, saldo]
                    properties:
                      cpf:
                        type: string
                        pattern: "^[0-9]{11}$"
                      nome:
                        type: string
                        minLength: 3
                      saldo:
                        type: number
                        minimum: 0
                  states:
                    initial: DRAFT
                    states: [DRAFT, ACTIVE, SUSPENDED, CLOSED]
                    transitions:
                      - from: DRAFT
                        to: ACTIVE
                      - from: ACTIVE
                        to: SUSPENDED
                      - from: SUSPENDED
                        to: ACTIVE
                      - from: ACTIVE
                        to: CLOSED
      responses:
        '201':
          description: Object definition created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ObjectDefinition'
        '400':
          description: Invalid request body
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /object-definitions/{id}:
    parameters:
      - name: id
        in: path
        required: true
        schema:
          type: string
          format: uuid

    get:
      tags: [Object Definitions]
      summary: Get object definition by ID
      operationId: getObjectDefinition
      responses:
        '200':
          description: Object definition found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ObjectDefinition'
        '404':
          description: Object definition not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

    put:
      tags: [Object Definitions]
      summary: Update object definition
      operationId: updateObjectDefinition
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateObjectDefinition'
      responses:
        '200':
          description: Object definition updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ObjectDefinition'
        '404':
          description: Object definition not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

    delete:
      tags: [Object Definitions]
      summary: Delete object definition
      description: Soft delete an object definition (marks as inactive)
      operationId: deleteObjectDefinition
      responses:
        '204':
          description: Object definition deleted
        '404':
          description: Object definition not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /object-definitions/{id}/schema:
    parameters:
      - name: id
        in: path
        required: true
        schema:
          type: string
          format: uuid

    get:
      tags: [Object Definitions]
      summary: Get JSON Schema for object definition
      description: Returns only the JSON Schema portion for form generation
      operationId: getObjectDefinitionSchema
      responses:
        '200':
          description: JSON Schema
          content:
            application/json:
              schema:
                type: object
                description: JSON Schema Draft 7

  # ============================================================================
  # INSTANCES ENDPOINTS
  # ============================================================================

  /instances:
    get:
      tags: [Instances]
      summary: List instances
      description: Returns a paginated list of instances
      operationId: listInstances
      parameters:
        - name: object_definition_id
          in: query
          schema:
            type: string
            format: uuid
          description: Filter by object definition
        - name: current_state
          in: query
          schema:
            type: string
          description: Filter by current state
        - name: limit
          in: query
          schema:
            type: integer
            default: 20
        - name: offset
          in: query
          schema:
            type: integer
            default: 0
      responses:
        '200':
          description: List of instances
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/Instance'
                  total:
                    type: integer

    post:
      tags: [Instances]
      summary: Create a new instance
      description: Creates a new instance from an object definition
      operationId: createInstance
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateInstance'
            examples:
              conta_corrente:
                summary: Create a checking account instance
                value:
                  object_definition_id: 550e8400-e29b-41d4-a716-446655440000
                  data:
                    cpf: "12345678901"
                    nome: "João Silva"
                    saldo: 1000.00
      responses:
        '201':
          description: Instance created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Instance'
        '400':
          description: Validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /instances/{id}:
    parameters:
      - name: id
        in: path
        required: true
        schema:
          type: string
          format: uuid

    get:
      tags: [Instances]
      summary: Get instance by ID
      operationId: getInstance
      responses:
        '200':
          description: Instance found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Instance'
        '404':
          description: Instance not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

    put:
      tags: [Instances]
      summary: Update instance data
      operationId: updateInstance
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateInstance'
      responses:
        '200':
          description: Instance updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Instance'

    delete:
      tags: [Instances]
      summary: Delete instance
      description: Soft delete an instance
      operationId: deleteInstance
      responses:
        '204':
          description: Instance deleted

  /instances/{id}/transition:
    parameters:
      - name: id
        in: path
        required: true
        schema:
          type: string
          format: uuid

    post:
      tags: [Instances]
      summary: Transition instance state
      description: Moves instance to a new state using the FSM
      operationId: transitionInstanceState
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [to_state]
              properties:
                to_state:
                  type: string
                  example: ACTIVE
                reason:
                  type: string
                  example: KYC verification completed
      responses:
        '200':
          description: State transition successful
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Instance'
        '400':
          description: Invalid state transition
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /instances/{id}/history:
    parameters:
      - name: id
        in: path
        required: true
        schema:
          type: string
          format: uuid

    get:
      tags: [Instances]
      summary: Get instance state history
      description: Returns the complete state transition history
      operationId: getInstanceHistory
      responses:
        '200':
          description: State history
          content:
            application/json:
              schema:
                type: array
                items:
                  type: object
                  properties:
                    state:
                      type: string
                    timestamp:
                      type: string
                      format: date-time
                    user:
                      type: string
                    reason:
                      type: string

  /instances/{id}/relationships:
    parameters:
      - name: id
        in: path
        required: true
        schema:
          type: string
          format: uuid

    get:
      tags: [Relationships]
      summary: Get all relationships for an instance
      description: Returns both outgoing and incoming relationships
      operationId: getInstanceRelationships
      responses:
        '200':
          description: List of relationships
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Relationship'

  # ============================================================================
  # RELATIONSHIPS ENDPOINTS
  # ============================================================================

  /relationships:
    get:
      tags: [Relationships]
      summary: List relationships
      operationId: listRelationships
      parameters:
        - name: source_instance_id
          in: query
          schema:
            type: string
            format: uuid
        - name: target_instance_id
          in: query
          schema:
            type: string
            format: uuid
        - name: relationship_type
          in: query
          schema:
            type: string
      responses:
        '200':
          description: List of relationships
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Relationship'

    post:
      tags: [Relationships]
      summary: Create a new relationship
      description: Creates a directed relationship between two instances
      operationId: createRelationship
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateRelationship'
            examples:
              customer_owns_account:
                summary: Customer owns account
                value:
                  relationship_type: OWNS
                  source_instance_id: 550e8400-e29b-41d4-a716-446655440000
                  target_instance_id: 660e8400-e29b-41d4-a716-446655440001
                  properties:
                    ownership_percentage: 100
      responses:
        '201':
          description: Relationship created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Relationship'

  /relationships/{id}:
    parameters:
      - name: id
        in: path
        required: true
        schema:
          type: string
          format: uuid

    get:
      tags: [Relationships]
      summary: Get relationship by ID
      operationId: getRelationship
      responses:
        '200':
          description: Relationship found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Relationship'

    delete:
      tags: [Relationships]
      summary: Delete relationship
      operationId: deleteRelationship
      responses:
        '204':
          description: Relationship deleted

  # ============================================================================
  # VALIDATION RULES ENDPOINTS
  # ============================================================================

  /validation-rules:
    get:
      tags: [Validation Rules]
      summary: List validation rules
      operationId: listValidationRules
      parameters:
        - name: rule_type
          in: query
          schema:
            type: string
        - name: tags
          in: query
          schema:
            type: array
            items:
              type: string
          style: form
          explode: false
      responses:
        '200':
          description: List of validation rules
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/ValidationRule'

    post:
      tags: [Validation Rules]
      summary: Create validation rule
      operationId: createValidationRule
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateValidationRule'
      responses:
        '201':
          description: Validation rule created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ValidationRule'

  /validation-rules/{id}:
    parameters:
      - name: id
        in: path
        required: true
        schema:
          type: string
          format: uuid

    get:
      tags: [Validation Rules]
      summary: Get validation rule by ID
      operationId: getValidationRule
      responses:
        '200':
          description: Validation rule found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ValidationRule'

    put:
      tags: [Validation Rules]
      summary: Update validation rule
      operationId: updateValidationRule
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateValidationRule'
      responses:
        '200':
          description: Validation rule updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ValidationRule'

    delete:
      tags: [Validation Rules]
      summary: Delete validation rule
      operationId: deleteValidationRule
      responses:
        '204':
          description: Validation rule deleted

  # ============================================================================
  # NATURAL LANGUAGE ASSISTANT ENDPOINTS
  # ============================================================================

  /assistant/chat:
    post:
      tags: [NL Assistant]
      summary: Chat with the Natural Language Assistant
      description: |
        General purpose chat endpoint for asking questions about the platform,
        getting help, or having the assistant guide you through tasks.
      operationId: assistantChat
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [message]
              properties:
                message:
                  type: string
                  example: "Como faço para criar uma conta corrente?"
                context:
                  type: object
                  description: Optional context for the conversation
      responses:
        '200':
          description: Assistant response
          content:
            application/json:
              schema:
                type: object
                properties:
                  response:
                    type: string
                  suggestions:
                    type: array
                    items:
                      type: string

  /assistant/generate-object-definition:
    post:
      tags: [NL Assistant]
      summary: Generate object definition from natural language
      description: |
        Provide a natural language description of what you want to create,
        and the assistant will generate a complete object definition with
        schema, states, and validation rules.
      operationId: generateObjectDefinition
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [description]
              properties:
                description:
                  type: string
                  example: "Preciso de uma conta corrente para pessoa física com CPF, nome, saldo e limite"
      responses:
        '200':
          description: Generated object definition
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ObjectDefinition'

  /assistant/refine-schema:
    post:
      tags: [NL Assistant]
      summary: Refine an existing schema
      description: |
        Provide feedback or changes you want to make to an existing schema,
        and the assistant will update it accordingly.
      operationId: refineSchema
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [object_definition_id, refinement]
              properties:
                object_definition_id:
                  type: string
                  format: uuid
                refinement:
                  type: string
                  example: "Adiciona um campo de email obrigatório"
      responses:
        '200':
          description: Refined schema
          content:
            application/json:
              schema:
                type: object
                properties:
                  schema:
                    type: object

# ============================================================================
# COMPONENTS
# ============================================================================

components:
  schemas:
    OracleIdentity:
      type: object
      properties:
        cnpj:
          type: string
          example: "12.345.678/0001-90"
        razao_social:
          type: string
          example: "LBPAY INSTITUICAO DE PAGAMENTO LTDA"
        nome_fantasia:
          type: string
          example: "LBPAY"
        ispb:
          type: string
          example: "12345678"
        tipo_instituicao:
          type: string
          example: "Instituição de Pagamento"

    License:
      type: object
      properties:
        id:
          type: string
          format: uuid
        tipo:
          type: string
          example: "INSTITUICAO_PAGAMENTO"
        orgao_emissor:
          type: string
          example: "Banco Central do Brasil"
        numero_autorizacao:
          type: string
        data_emissao:
          type: string
          format: date
        data_validade:
          type: string
          format: date
        status:
          type: string
          enum: [ATIVA, SUSPENSA, REVOGADA]

    OracleStatus:
      type: object
      properties:
        identity:
          $ref: '#/components/schemas/OracleIdentity'
        licenses:
          type: array
          items:
            $ref: '#/components/schemas/License'
        integrations:
          type: array
          items:
            type: object
        operational_status:
          type: string
          enum: [OPERATIONAL, DEGRADED, DOWN]

    ObjectDefinition:
      type: object
      properties:
        id:
          type: string
          format: uuid
        name:
          type: string
          example: conta_corrente
        display_name:
          type: string
          example: Conta Corrente PF
        description:
          type: string
        version:
          type: integer
        schema:
          type: object
          description: JSON Schema Draft 7
        rules:
          type: array
          items:
            type: object
        states:
          type: object
        ui_hints:
          type: object
        relationships:
          type: array
        category:
          type: string
          enum: [BUSINESS_ENTITY, RULE, POLICY, INTEGRATION, LOGIC]
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time
        is_active:
          type: boolean

    CreateObjectDefinition:
      type: object
      required: [name, display_name, schema, category]
      properties:
        name:
          type: string
        display_name:
          type: string
        description:
          type: string
        schema:
          type: object
        rules:
          type: array
        states:
          type: object
        ui_hints:
          type: object
        relationships:
          type: array
        category:
          type: string
          enum: [BUSINESS_ENTITY, RULE, POLICY, INTEGRATION, LOGIC]

    UpdateObjectDefinition:
      type: object
      properties:
        display_name:
          type: string
        description:
          type: string
        schema:
          type: object
        rules:
          type: array
        states:
          type: object
        ui_hints:
          type: object
        relationships:
          type: array

    Instance:
      type: object
      properties:
        id:
          type: string
          format: uuid
        object_definition_id:
          type: string
          format: uuid
        data:
          type: object
        current_state:
          type: string
        state_history:
          type: array
        version:
          type: integer
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time
        is_deleted:
          type: boolean

    CreateInstance:
      type: object
      required: [object_definition_id, data]
      properties:
        object_definition_id:
          type: string
          format: uuid
        data:
          type: object

    UpdateInstance:
      type: object
      required: [data]
      properties:
        data:
          type: object

    Relationship:
      type: object
      properties:
        id:
          type: string
          format: uuid
        relationship_type:
          type: string
          example: OWNS
        source_instance_id:
          type: string
          format: uuid
        target_instance_id:
          type: string
          format: uuid
        properties:
          type: object
        created_at:
          type: string
          format: date-time

    CreateRelationship:
      type: object
      required: [relationship_type, source_instance_id, target_instance_id]
      properties:
        relationship_type:
          type: string
        source_instance_id:
          type: string
          format: uuid
        target_instance_id:
          type: string
          format: uuid
        properties:
          type: object

    ValidationRule:
      type: object
      properties:
        id:
          type: string
          format: uuid
        name:
          type: string
        description:
          type: string
        rule_type:
          type: string
        implementation:
          type: object
        tags:
          type: array
          items:
            type: string
        is_active:
          type: boolean

    CreateValidationRule:
      type: object
      required: [name, rule_type, implementation]
      properties:
        name:
          type: string
        description:
          type: string
        rule_type:
          type: string
        implementation:
          type: object
        tags:
          type: array
          items:
            type: string

    UpdateValidationRule:
      type: object
      properties:
        name:
          type: string
        description:
          type: string
        implementation:
          type: object
        tags:
          type: array
          items:
            type: string
        is_active:
          type: boolean

    Error:
      type: object
      properties:
        error:
          type: string
        message:
          type: string
        details:
          type: object
