# ==============================================================================
# SuperCore v2.0 - Development Environment
# ==============================================================================
# Services:
#   - PostgreSQL 16 (primary data store + pgvector)
#   - Redis 7 (cache layer)
#   - Temporal Server 1.23 (workflow orchestration, REPLACES Celery)
#   - NebulaGraph 3.8 (knowledge graph database)
#   - Qdrant (vector database for RAG embeddings)
#   - MinIO (S3-compatible object storage)
#
# Notes:
#   - Temporal: Replaces Celery for background jobs + complex workflows
#   - Redis: Cache only, NOT message broker
#   - NebulaGraph: 3 services (metad, storaged, graphd) for distributed setup
#   - Auto-migrations: PostgreSQL runs migrations from docker-entrypoint-initdb.d
# ==============================================================================

services:
  # ===========================================================================
  # PostgreSQL 16 (Primary Data Store + pgvector)
  # ===========================================================================
  postgres:
    image: pgvector/pgvector:pg16-latest
    container_name: supercore-postgres
    restart: unless-stopped
    environment:
      POSTGRES_DB: supercore_dev
      POSTGRES_USER: supercore
      POSTGRES_PASSWORD: supercore_dev_password
      POSTGRES_INITDB_ARGS: >
        --encoding=UTF8
        --locale=en_US.UTF-8
    ports:
      - "5432:5432"
    volumes:
      # Auto-run migrations on startup
      - ../database/migrations:/docker-entrypoint-initdb.d:ro
      # Persistent data storage
      - postgres_data:/var/lib/postgresql/data
      # Custom PostgreSQL config (if needed)
      - ./postgres-init.sql:/docker-entrypoint-initdb.d/00-init.sql:ro
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U supercore -d supercore_dev"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    networks:
      - supercore-net
    depends_on: []

  # ===========================================================================
  # Redis 7 (Cache Layer - NOT Task Queue)
  # ===========================================================================
  redis:
    image: redis:7-alpine
    container_name: supercore-redis
    restart: unless-stopped
    command:
      - redis-server
      - "--appendonly"
      - "yes"
      - "--appendfsync"
      - "everysec"
      - "--maxmemory"
      - "512mb"
      - "--maxmemory-policy"
      - "allkeys-lru"
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    networks:
      - supercore-net
    depends_on: []

  # ===========================================================================
  # Temporal Database (PostgreSQL for Temporal)
  # ===========================================================================
  temporal-postgres:
    image: postgres:16-alpine
    container_name: supercore-temporal-postgres
    restart: unless-stopped
    environment:
      POSTGRES_DB: temporal
      POSTGRES_USER: temporal
      POSTGRES_PASSWORD: temporal_password
      POSTGRES_INITDB_ARGS: "--encoding=UTF8 --locale=en_US.UTF-8"
    ports:
      - "5433:5432"
    volumes:
      - temporal_postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U temporal -d temporal"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    networks:
      - supercore-net
    depends_on: []

  # ===========================================================================
  # Temporal Elasticsearch (for visibility & analytics)
  # ===========================================================================
  temporal-elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:8.10.0
    container_name: supercore-temporal-elasticsearch
    restart: unless-stopped
    environment:
      - discovery.type=single-node
      - xpack.security.enabled=false
      - "ES_JAVA_OPTS=-Xms512m -Xmx512m"
    ports:
      - "9200:9200"
    volumes:
      - temporal_es_data:/usr/share/elasticsearch/data
    healthcheck:
      test: ["CMD-SHELL", "curl -s http://localhost:9200/_cluster/health | grep -q 'yellow\\|green'"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    networks:
      - supercore-net
    depends_on: []

  # ===========================================================================
  # Temporal Server 1.23 (Workflow Orchestration - Replaces Celery)
  # ===========================================================================
  temporal:
    image: temporalio/auto-setup:1.23.0
    container_name: supercore-temporal
    restart: unless-stopped
    depends_on:
      temporal-postgres:
        condition: service_healthy
      temporal-elasticsearch:
        condition: service_healthy
    environment:
      # Database Configuration
      DB: postgresql
      DB_PORT: 5432
      POSTGRES_USER: temporal
      POSTGRES_PWD: temporal_password
      POSTGRES_SEEDS: temporal-postgres
      # Elasticsearch Configuration
      VISIBILITY_DBTYPE: elasticsearch
      VISIBILITY_ELASTICSEARCH_URL: http://temporal-elasticsearch:9200
      # Server Configuration
      TEMPORAL_ADDRESS: 0.0.0.0:7233
      BIND_ON_IP: 0.0.0.0
      ENABLE_PROMETHEUS_METRICS: "true"
      # Performance Tuning
      TEMPORAL_MATCH_COST: "1000"
    ports:
      - "7233:7233"  # gRPC server
      - "7234:7234"  # gRPC metrics
      - "9090:9090"  # Prometheus metrics
    volumes:
      # Dynamic config (if needed)
      - ./temporal-config/development.yaml:/etc/temporal/config/dynamicconfig/development.yaml:ro
    healthcheck:
      test: ["CMD", "tctl", "cluster", "describe"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 20s
    networks:
      - supercore-net

  # ===========================================================================
  # Temporal UI (Web Dashboard)
  # ===========================================================================
  temporal-ui:
    image: temporalio/ui:2.21.0
    container_name: supercore-temporal-ui
    restart: unless-stopped
    depends_on:
      temporal:
        condition: service_healthy
    environment:
      TEMPORAL_ADDRESS: temporal:7233
      TEMPORAL_TLS_ENABLED: "false"
    ports:
      - "8088:8080"  # Web UI
    networks:
      - supercore-net

  # ===========================================================================
  # NebulaGraph Meta Service (Metadata Management)
  # ===========================================================================
  nebula-metad:
    image: vesoft/nebula-metad:v3.8.0
    container_name: supercore-nebula-metad
    restart: unless-stopped
    environment:
      USER: root
    command:
      - --meta_server_addrs=nebula-metad:9559
      - --local_ip=nebula-metad
      - --ws_ip=nebula-metad
      - --port=9559
      - --heartbeat_interval_secs=1
    ports:
      - "9559:9559"
      - "19559:19559"
    volumes:
      - nebula_meta:/data/meta
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:19559/status"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    networks:
      - nebula-net

  # ===========================================================================
  # NebulaGraph Storage Service (Data Storage)
  # ===========================================================================
  nebula-storaged:
    image: vesoft/nebula-storaged:v3.8.0
    container_name: supercore-nebula-storaged
    restart: unless-stopped
    environment:
      USER: root
    command:
      - --meta_server_addrs=nebula-metad:9559
      - --local_ip=nebula-storaged
      - --ws_ip=nebula-storaged
      - --port=9779
      - --heartbeat_interval_secs=1
    ports:
      - "9779:9779"
      - "19779:19779"
    volumes:
      - nebula_storage:/data/storage
    depends_on:
      nebula-metad:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:19779/status"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    networks:
      - nebula-net

  # ===========================================================================
  # NebulaGraph Graph Service (Query Execution)
  # ===========================================================================
  nebula-graphd:
    image: vesoft/nebula-graphd:v3.8.0
    container_name: supercore-nebula-graphd
    restart: unless-stopped
    environment:
      USER: root
    command:
      - --meta_server_addrs=nebula-metad:9559
      - --local_ip=nebula-graphd
      - --ws_ip=nebula-graphd
      - --port=9669
      - --heartbeat_interval_secs=1
      - --max_allowed_query_execution_duration=600000
    ports:
      - "9669:9669"
      - "19669:19669"
    depends_on:
      nebula-metad:
        condition: service_healthy
      nebula-storaged:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:19669/status"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s
    networks:
      - nebula-net

  # ===========================================================================
  # NebulaGraph Console (CLI & Debugging)
  # ===========================================================================
  nebula-console:
    image: vesoft/nebula-console:v3.8.0
    container_name: supercore-nebula-console
    restart: unless-stopped
    entrypoint: ""
    command: sh -c "sleep infinity"
    depends_on:
      nebula-graphd:
        condition: service_healthy
    networks:
      - nebula-net

  # ===========================================================================
  # Qdrant (Vector Database for RAG Embeddings)
  # ===========================================================================
  qdrant:
    image: qdrant/qdrant:v1.7.0
    container_name: supercore-qdrant
    restart: unless-stopped
    ports:
      - "6333:6333"  # HTTP API
      - "6334:6334"  # gRPC API
    volumes:
      - qdrant_data:/qdrant/storage
    environment:
      - QDRANT__SERVICE__HTTP_PORT=6333
      - QDRANT__SERVICE__GRPC_PORT=6334
      - QDRANT__STORAGE__SNAPSHOTS_PATH=/qdrant/snapshots
      - QDRANT__STORAGE__TEMP_PATH=/qdrant/temp
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:6333/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    networks:
      - supercore-net

  # ===========================================================================
  # MinIO (S3-Compatible Object Storage)
  # ===========================================================================
  minio:
    image: minio/minio:latest
    container_name: supercore-minio
    restart: unless-stopped
    command: server /data --console-address ":9001" --address ":9000"
    environment:
      MINIO_ROOT_USER: minio_admin
      MINIO_ROOT_PASSWORD: minio_password_change_me
      MINIO_BROWSER: "on"
    ports:
      - "9000:9000"  # S3 API
      - "9001:9001"  # Web Console
    volumes:
      - minio_data:/data
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    networks:
      - supercore-net

# ==============================================================================
# Networks
# ==============================================================================
networks:
  # Main network for PostgreSQL, Redis, Qdrant, MinIO services
  supercore-net:
    driver: bridge

  # Separate network for NebulaGraph cluster
  nebula-net:
    driver: bridge

# ==============================================================================
# Volumes (Persistent Data Storage)
# ==============================================================================
volumes:
  postgres_data:
    driver: local
  redis_data:
    driver: local
  temporal_postgres_data:
    driver: local
  temporal_es_data:
    driver: local
  nebula_meta:
    driver: local
  nebula_storage:
    driver: local
  qdrant_data:
    driver: local
  minio_data:
    driver: local
