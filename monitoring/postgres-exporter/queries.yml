# Custom PostgreSQL queries for SuperCore business metrics

# Object Definitions metrics
pg_object_definitions:
  query: |
    SELECT
      COUNT(*) FILTER (WHERE is_active = true) as active_count,
      COUNT(*) FILTER (WHERE is_active = false) as inactive_count,
      COUNT(*) as total_count
    FROM object_definitions
  metrics:
    - active_count:
        usage: "GAUGE"
        description: "Number of active object definitions"
    - inactive_count:
        usage: "GAUGE"
        description: "Number of inactive object definitions"
    - total_count:
        usage: "GAUGE"
        description: "Total number of object definitions"

# Instances by object type
pg_instances_by_type:
  query: |
    SELECT
      od.name as object_type,
      COUNT(i.id) as instance_count
    FROM object_definitions od
    LEFT JOIN instances i ON i.object_definition_id = od.id AND i.is_deleted = false
    WHERE od.is_active = true
    GROUP BY od.name
  metrics:
    - object_type:
        usage: "LABEL"
        description: "Object definition name"
    - instance_count:
        usage: "GAUGE"
        description: "Number of instances for this object type"

# Instances by state
pg_instances_by_state:
  query: |
    SELECT
      od.name as object_type,
      i.current_state as state,
      COUNT(i.id) as instance_count
    FROM object_definitions od
    LEFT JOIN instances i ON i.object_definition_id = od.id AND i.is_deleted = false
    WHERE od.is_active = true
    GROUP BY od.name, i.current_state
  metrics:
    - object_type:
        usage: "LABEL"
        description: "Object definition name"
    - state:
        usage: "LABEL"
        description: "Current state of instances"
    - instance_count:
        usage: "GAUGE"
        description: "Number of instances in this state"

# Relationships metrics
pg_relationships:
  query: |
    SELECT
      relationship_type,
      COUNT(*) as count,
      COUNT(*) FILTER (WHERE valid_until IS NULL OR valid_until > NOW()) as active_count
    FROM relationships
    GROUP BY relationship_type
  metrics:
    - relationship_type:
        usage: "LABEL"
        description: "Type of relationship"
    - count:
        usage: "GAUGE"
        description: "Total number of relationships"
    - active_count:
        usage: "GAUGE"
        description: "Number of active relationships"

# Database table sizes
pg_table_sizes:
  query: |
    SELECT
      schemaname || '.' || tablename as table_name,
      pg_total_relation_size(schemaname||'.'||tablename) as total_bytes,
      pg_relation_size(schemaname||'.'||tablename) as data_bytes,
      pg_indexes_size(schemaname||'.'||tablename) as index_bytes
    FROM pg_tables
    WHERE schemaname NOT IN ('pg_catalog', 'information_schema')
    ORDER BY pg_total_relation_size(schemaname||'.'||tablename) DESC
    LIMIT 20
  metrics:
    - table_name:
        usage: "LABEL"
        description: "Table name"
    - total_bytes:
        usage: "GAUGE"
        description: "Total size including indexes"
    - data_bytes:
        usage: "GAUGE"
        description: "Data size"
    - index_bytes:
        usage: "GAUGE"
        description: "Index size"

# Recent instance creation rate
pg_instance_creation_rate:
  query: |
    SELECT
      od.name as object_type,
      COUNT(*) FILTER (WHERE i.created_at > NOW() - INTERVAL '1 hour') as last_hour,
      COUNT(*) FILTER (WHERE i.created_at > NOW() - INTERVAL '24 hours') as last_day,
      COUNT(*) FILTER (WHERE i.created_at > NOW() - INTERVAL '7 days') as last_week
    FROM object_definitions od
    LEFT JOIN instances i ON i.object_definition_id = od.id AND i.is_deleted = false
    WHERE od.is_active = true
    GROUP BY od.name
  metrics:
    - object_type:
        usage: "LABEL"
        description: "Object definition name"
    - last_hour:
        usage: "GAUGE"
        description: "Instances created in last hour"
    - last_day:
        usage: "GAUGE"
        description: "Instances created in last 24 hours"
    - last_week:
        usage: "GAUGE"
        description: "Instances created in last 7 days"

# Validation rules usage
pg_validation_rules:
  query: |
    SELECT
      rule_type,
      COUNT(*) as count,
      COUNT(*) FILTER (WHERE is_system = true) as system_count
    FROM validation_rules
    GROUP BY rule_type
  metrics:
    - rule_type:
        usage: "LABEL"
        description: "Type of validation rule"
    - count:
        usage: "GAUGE"
        description: "Total validation rules"
    - system_count:
        usage: "GAUGE"
        description: "System validation rules"

# Long-running queries
pg_long_queries:
  query: |
    SELECT
      COUNT(*) as count,
      COUNT(*) FILTER (WHERE state = 'active') as active_count,
      MAX(EXTRACT(EPOCH FROM (NOW() - query_start))) as max_duration_seconds
    FROM pg_stat_activity
    WHERE query_start IS NOT NULL
      AND query NOT LIKE '%pg_stat_activity%'
      AND state <> 'idle'
  metrics:
    - count:
        usage: "GAUGE"
        description: "Number of queries running"
    - active_count:
        usage: "GAUGE"
        description: "Number of active queries"
    - max_duration_seconds:
        usage: "GAUGE"
        description: "Longest running query duration"

# Database locks
pg_locks:
  query: |
    SELECT
      mode,
      COUNT(*) as lock_count
    FROM pg_locks
    WHERE NOT granted
    GROUP BY mode
  metrics:
    - mode:
        usage: "LABEL"
        description: "Lock mode"
    - lock_count:
        usage: "GAUGE"
        description: "Number of locks waiting"

# Instance version history depth
pg_instance_versions:
  query: |
    SELECT
      od.name as object_type,
      AVG(i.version) as avg_version,
      MAX(i.version) as max_version
    FROM object_definitions od
    LEFT JOIN instances i ON i.object_definition_id = od.id AND i.is_deleted = false
    WHERE od.is_active = true
    GROUP BY od.name
  metrics:
    - object_type:
        usage: "LABEL"
        description: "Object definition name"
    - avg_version:
        usage: "GAUGE"
        description: "Average version number"
    - max_version:
        usage: "GAUGE"
        description: "Maximum version number"
