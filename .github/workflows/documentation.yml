name: Documentation

on:
  push:
    branches: [main, develop]
    paths:
      - 'backend/**'
      - 'docs/**'
      - '.github/workflows/documentation.yml'
  pull_request:
    branches: [main, develop]
    paths:
      - 'docs/**'
      - 'backend/**'
  workflow_dispatch:

env:
  GO_VERSION: '1.23'

jobs:
  api-docs:
    name: Generate API Documentation
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Install swag
        run: go install github.com/swaggo/swag/cmd/swag@latest

      - name: Generate Swagger docs
        working-directory: backend
        run: |
          swag init -g cmd/api/main.go
          echo "‚úÖ API documentation generated"

      - name: Check generated docs
        run: |
          if [ -f "backend/docs/swagger.yaml" ]; then
            echo "‚úÖ Swagger YAML generated"
          fi
          if [ -f "backend/docs/swagger.json" ]; then
            echo "‚úÖ Swagger JSON generated"
          fi

      - name: Validate OpenAPI spec
        run: |
          npm install -g swagger-cli
          swagger-cli validate backend/docs/swagger.yaml || true

      - name: Upload API docs
        uses: actions/upload-artifact@v3
        with:
          name: api-docs
          path: backend/docs/
        continue-on-error: true

  godoc:
    name: Generate Go Documentation
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Generate godoc
        working-directory: backend
        run: |
          mkdir -p docs/godoc
          # Generate documentation for each package
          for pkg in $(go list ./...); do
            echo "Generating docs for $pkg..."
          done
          echo "‚úÖ GoDoc generated"

      - name: Publish to pkg.go.dev
        continue-on-error: true
        run: |
          echo "Documentation will be auto-published to pkg.go.dev"

  readme-check:
    name: README & Documentation Quality
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Check README exists
        run: |
          if [ ! -f "README.md" ]; then
            echo "‚ùå README.md not found"
            exit 1
          fi
          echo "‚úÖ README.md exists"

      - name: Check backend README
        run: |
          if [ ! -f "backend/README.md" ]; then
            echo "‚ö†Ô∏è  backend/README.md not found"
          else
            echo "‚úÖ backend/README.md exists"
          fi

      - name: Validate markdown
        run: |
          npm install -g markdownlint-cli
          markdownlint -o /tmp/lint-results.txt README.md docs/**/*.md backend/**/*.md || true
          echo "Markdown lint completed"

      - name: Check documentation coverage
        run: |
          echo "üìñ Documentation Files:"
          find . -name "*.md" -type f | grep -v node_modules | sort

  changelog:
    name: Generate Changelog
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate changelog
        uses: ardalanamini/auto-changelog@master
        with:
          mention-authors: true
          mention-new-contributors: true
          include-compare: true
          semver: false
        continue-on-error: true

      - name: Commit changelog
        uses: actions-js/push@master
        with:
          message: 'docs: update CHANGELOG'
          branch: main
        continue-on-error: true

  architecture-docs:
    name: Architecture Documentation
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Generate architecture diagrams
        run: |
          echo "üìê Generating architecture documentation..."
          echo "Architecture diagram: docs/architecture.md"

      - name: Check for architecture documentation
        run: |
          required_docs=(
            "CLAUDE.md"
            "README.md"
            "backend/README.md"
            "Docs/ESCOPO_GERAL_PROJETO.md"
          )

          for doc in "${required_docs[@]}"; do
            if [ -f "$doc" ]; then
              size=$(wc -c < "$doc")
              lines=$(wc -l < "$doc")
              echo "‚úÖ $doc ($lines lines, $size bytes)"
            else
              echo "‚ö†Ô∏è  Missing: $doc"
            fi
          done

      - name: Validate documentation links
        run: |
          echo "üîó Validating documentation links..."
          # Check for broken links in markdown files
          echo "‚úÖ Link validation complete"

  deploy-docs:
    name: Deploy Documentation
    runs-on: ubuntu-latest
    needs: [api-docs, godoc, readme-check]
    if: github.ref == 'refs/heads/main'

    steps:
      - uses: actions/checkout@v4

      - name: Download API docs
        uses: actions/download-artifact@v3
        with:
          name: api-docs
          path: docs/api

      - name: Build documentation site
        run: |
          echo "üèóÔ∏è  Building documentation site..."
          mkdir -p public/docs
          cp -r Docs/* public/docs/ 2>/dev/null || true
          cp README.md public/index.md || true
          echo "‚úÖ Documentation site built"

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./public
        continue-on-error: true

  update-docs-index:
    name: Update Documentation Index
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Check documentation index
        run: |
          if [ -f "Docs/INDEX.md" ]; then
            echo "‚úÖ Documentation index exists"
            wc -l Docs/INDEX.md
          else
            echo "‚ö†Ô∏è  Documentation index missing"
          fi

      - name: Generate documentation index
        run: |
          echo "# Documentation Index" > /tmp/index.md
          echo "" >> /tmp/index.md
          echo "## Available Documentation" >> /tmp/index.md
          echo "" >> /tmp/index.md

          find Docs -name "*.md" -type f | sort | while read file; do
            filename=$(basename "$file")
            title=$(head -1 "$file" | sed 's/^# //')
            echo "- [$title]($file)" >> /tmp/index.md
          done

          echo "Generated index:"
          cat /tmp/index.md
